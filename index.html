<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T9WB2NYLFC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T9WB2NYLFC');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Affiliate Analytics Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è Affiliate Analytics Dashboard */

:root {
    --bg-primary: #0f1419;
    --bg-secondary: #1a1f2e;
    --bg-tertiary: #242b3d;
    --text-primary: #e6eef6;
    --text-muted: #a0aec0;
    --border: #2d3748;
    --accent: #667eea;
    --positive: #48bb78;
    --negative: #f56565;
    --warning: #ecc94b;
    --header-height: 80px;
    --filters-height: auto;
}

* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
}

.container { 
    max-width: 1800px; 
    margin: 0 auto;
    padding: 20px 20px 40px;
}

/* –û–±—ã—á–Ω—ã–π —Ö–µ–¥–µ—Ä (–Ω–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) */
.header {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 0;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
    background: linear-gradient(135deg, rgba(26, 31, 46, 0.5) 0%, rgba(36, 43, 61, 0.5) 100%);
    padding: 20px 40px;
    border-radius: 12px;
}
.filters>p{
    position: absolute;
    top: 12%;
    left:1rem;
    color: rgba(255, 255, 255, 0.405);
    font-size: 0.7rem;
}
h1 { 
    font-size: 28px; 
    font-weight: 700;
    background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.file-upload {
    background: var(--accent);
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.file-upload:hover { 
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.file-upload input { display: none; }

.file-upload label {
    cursor: pointer;
    color: white;
    font-weight: 600;
    font-size: 14px;
}

/* Sticky —Ñ–∏–ª—å—Ç—Ä—ã - –ø—Ä–∏–ª–∏–ø–∞—é—Ç –∫ –≤–µ—Ä—Ö—É */
.filters {
    position: sticky;
    top: 0;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 16px;
    flex-wrap: wrap;
    margin: 0 0 32px;
    padding: 20px 24px;
    background: var(--bg-secondary);
    border-radius: 0 0 12px 12px;
    border: 1px solid var(--border);
    border-top: none;
    z-index: 999;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.filters::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--positive));
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* –ö–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–∫–ª–µ–µ–Ω—ã –∫ –≤–µ—Ä—Ö—É */
.filters.stuck {
    border-radius: 0 0 12px 12px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
}

.filters.stuck::before {
    opacity: 1;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 180px;
}

.filter-group label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-group select,
.filter-group input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s ease;
    width: 100%;
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-group select:hover,
.filter-group input:hover {
    border-color: var(--accent);
}

.btn-reset {
    background: var(--negative);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
    height: fit-content;
}

.btn-reset:hover { 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
}

/* –ú–µ—Ç—Ä–∏–∫–∏ */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.metric-card {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.metric-card:hover::before {
    opacity: 1;
}

.metric-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
}

.metric-value.positive { color: var(--positive); }
.metric-value.negative { color: var(--negative); }

/* –ü–∞–Ω–µ–ª–∏ */
.summary-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.panel {
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
}

.panel:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.panel strong {
    display: block;
    margin-bottom: 16px;
    color: var(--accent);
    font-size: 16px;
    font-weight: 700;
}

.small-note {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 12px;
    line-height: 1.6;
}

.compare-controls {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.compare-controls select {
    flex: 1;
    min-width: 150px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.2s ease;
}

.compare-controls select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.btn:hover { 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    box-shadow: none;
}

/* –ì—Ä–∞—Ñ–∏–∫–∏ */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.chart-container {
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
}

.chart-container h3 {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
}

.chart-wrapper {
    position: relative;
    height: 320px;
}

/* –¢–∞–±–ª–∏—Ü—ã */
.table-container {
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: 12px;
    border: 1px solid var(--border);
    margin-bottom: 32px;
}

.table-container h3 {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

thead {
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
    z-index: 10;
}

th {
    padding: 14px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 0.5px;
}

td {
    padding: 14px 12px;
    border-bottom: 1px solid var(--border);
}

tbody tr {
    cursor: pointer;
    transition: all 0.2s ease;
}

tbody tr:hover {
    background: var(--bg-tertiary);
}

tbody tr.highlight-row {
    background: rgba(102, 126, 234, 0.15);
}

.positive { color: var(--positive) !important; font-weight: 600; }
.negative { color: var(--negative) !important; font-weight: 600; }
.warning { color: var(--warning) !important; font-weight: 600; }

.status-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.status-good {
    background: rgba(72, 187, 120, 0.2);
    color: var(--positive);
}

.status-bad {
    background: rgba(245, 101, 101, 0.2);
    color: var(--negative);
}

.details-expanded {
    background: var(--bg-tertiary);
    padding: 24px;
    border-radius: 12px;
    margin-top: 20px;
    border: 1px solid var(--border);
}

.no-data {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-muted);
}

.no-data p {
    font-size: 16px;
    line-height: 1.8;
}

.problem-item {
    padding: 14px;
    margin: 8px 0;
    background: var(--bg-tertiary);
    border-radius: 8px;
    border-left: 4px solid var(--negative);
    font-size: 13px;
    transition: all 0.2s ease;
}

.problem-item:hover {
    background: rgba(255, 255, 255, 0.05);
}

.problem-item.good {
    border-left-color: var(--positive);
}

.problem-item strong {
    color: var(--text-primary);
}

.split-detail {
    padding: 10px;
    margin: 6px 0;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    font-size: 13px;
}

.fd-contrib-table {
    width: 100%;
    margin-top: 16px;
    border-collapse: collapse;
    font-size: 13px;
}

.fd-contrib-table thead {
    background: var(--bg-tertiary);
}

.fd-contrib-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: 2px solid var(--border);
}

.fd-contrib-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

.fd-contrib-table tbody tr:hover {
    background: var(--bg-tertiary);
}

.toggle-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.toggle-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.small-cohort-list {
    background: var(--bg-tertiary);
    padding: 14px;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.7;
    border-radius: 8px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1400px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1024px) {
    .header {
        padding: 16px 20px;
        height: auto;
        flex-direction: column;
        gap: 16px;
    }
    
    body {
        padding-top: 120px;
    }
    
    .filters {
        top: 100px;
        gap: 12px;
        padding: 16px;
    }
    
    .filter-group {
        min-width: 140px;
    }
    
    .summary-panel {
        grid-template-columns: 1fr;
    }
    
    .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 0 12px 24px;
    }
    
    h1 {
        font-size: 22px;
    }
    
    .filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        min-width: 100%;
    }
    
    .compare-controls {
        flex-direction: column;
    }
    
    .compare-controls select {
        min-width: 100%;
    }
    
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    table {
        font-size: 12px;
    }
    
    th, td {
        padding: 10px 8px;
    }
    
    .chart-wrapper {
        height: 250px;
    }
}

@media (max-width: 480px) {
    body {
        padding-top: 140px;
    }
    
    .header {
        padding: 12px 16px;
    }
    
    h1 {
        font-size: 18px;
    }
    
    .file-upload {
        padding: 10px 16px;
    }
    
    .metric-value {
        font-size: 24px;
    }
    
    .panel {
        padding: 16px;
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.metric-card,
.panel,
.chart-container,
.table-container {
    animation: fadeIn 0.4s ease-out;
}
/* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
.screen-block {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #242b3d 100%);
    z-index: 99999;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.screen-block-content {
    text-align: center;
    max-width: 500px;
    animation: fadeIn 0.6s ease-out;
}

.screen-block-icon {
    font-size: 80px;
    margin-bottom: 24px;
    animation: pulse 2s infinite;
}

.screen-block h2 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 16px;
    line-height: 1.3;
}

.screen-block p {
    font-size: 16px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 12px;
}

.screen-block .highlight {
    color: var(--accent);
    font-weight: 600;
}

.screen-block-features {
    margin-top: 24px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid var(--border);
}

.screen-block-features ul {
    list-style: none;
    padding: 0;
    margin: 0;
    text-align: left;
}

.screen-block-features li {
    padding: 8px 0;
    color: var(--text-muted);
    font-size: 14px;
}

.screen-block-features li:before {
    content: "‚úì ";
    color: var(--positive);
    font-weight: bold;
    margin-right: 8px;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–∞—Ö –º–µ–Ω—å—à–µ 900px */
@media (max-width: 900px) {
    .screen-block {
        display: flex !important;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .container {
        display: none !important;
    }
}
</style>
</head>
<body>
<div class="screen-block">
    <div class="screen-block-content">
        <div class="screen-block-icon">üíª</div>
        <h2>–¢—Ä–µ–±—É–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞</h2>
        <p>
            –≠—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ 
            <span class="highlight">–¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</span> —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º —ç–∫—Ä–∞–Ω–∞ –æ—Ç 900px.
        </p>
        <p>
            –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö, –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
        </p>
        
        <div class="screen-block-features">
            <ul>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏–ª–∏ –Ω–æ—É—Ç–±—É–∫–µ</li>
                <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–∞–Ω—à–µ—Ç –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏</li>
                <li>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞: 900px</li>
            </ul>
        </div>
    </div>
</div>
<div class="container">
    <div class="header">
        <h1>Affiliate Marketing Analytics</h1>
        
        <div class="file-upload">
            <label for="csvFile">–ó–∞–≥—Ä—É–∑–∏—Ç—å CSV</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
    </div>

    <div id="filters" class="filters" style="display:none;">
        <p>01.07.2025 ‚Äì 27.12.2025<br>
Updated: 29.12.2025 05:52(msk) </p>
        <div class="filter-group">
            <label>–ü–∞—Ä—Ç–Ω—ë—Ä (Split 1)</label>
            <select id="partnerFilter" multiple size="4"></select>
        </div>
        <div class="filter-group">
            <label>–°—Ç—Ä–∞–Ω–∞ (Split 2)</label>
            <select id="countryFilter" multiple size="4"></select>
        </div>
        <div class="filter-group">
            <label>–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="filter-group">
            <label>–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" id="dateTo">
        </div>
        <div class="filter-group">
            <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π FTD</label>
            <input type="number" id="minFtd" placeholder="0">
        </div>
        <button class="btn-reset" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <div id="content" class="content" style="display:none;">
        <div class="metrics-grid" id="metricsGrid"></div>

        <div id="fd2Breakdown" style="margin-top:10px;color:var(--text-muted);font-size:13px;"></div>

        <div id="fd2Contributors" style="margin-top:6px;color:var(--text-muted);font-size:13px;"></div>
<div class="summary-panel">
            <div class="panel" id="problemCohorts">
                <strong>–ö–æ–≥–æ—Ä—Ç—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</strong>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;padding:8px;background:rgba(245,101,101,0.1);border-radius:4px;border-left:3px solid rgba(245,101,101,0.5);">
                    ‚Ä¢ OAS 7D < 0.30 |<br>
                    ‚Ä¢ FD‚Üí2Dep < 20% |<br>
                    ‚Ä¢ Profit 7D < -1000
                </div>
                <div id="problemList" style="margin-top:8px"></div>
            </div>

            <div class="panel" id="goodCohorts">
                <strong>–ü–µ—Ä—Ñ–æ—Ä–º—è—â–∏–µ –∫–æ–≥–æ—Ä—Ç—ã</strong>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;padding:8px;background:rgba(72,187,120,0.1);border-radius:4px;border-left:3px solid rgba(72,187,120,0.5);">
                    ‚Ä¢ OAS 7D ‚â• 0.40 &<br>
                    ‚Ä¢ Profit 7D > 0 &<br>
                    ‚Ä¢ FD‚Üí2Dep ‚â• 20% &<br>
                    ‚Ä¢ CPA < 250
                </div>
                <div id="goodList" style="margin-top:8px"></div>
            </div>

            <div class="panel" id="comparePanel">
                <strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</strong>
                <div class="compare-controls">
                    <select id="compareA"></select>
                    <select id="compareB"></select>
                    <button class="btn" onclick="compareSelected()">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
                </div>
                <div id="compareResult" class="small-note" style="margin-top:8px">–í—ã–±–µ—Ä–∏—Ç–µ 2 –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>CNGR –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º (Top 10 –ø–æ CNGR 7D)</h3>
                <div class="chart-wrapper"><canvas id="cngrChart"></canvas></div>
            </div>

            <div class="chart-container">
                <h3>OAS Dynamics (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–∞—Ç)</h3>
                <div class="chart-wrapper"><canvas id="oasChart"></canvas></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container" style="width:100%;">
                <h3>Cost vs CNGR  7D (–ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É)</h3>
                <div class="chart-wrapper"><canvas id="profitChart"></canvas></div>
            </div>
        </div>
        <!-- –í–°–¢–ê–í–ò–¢–¨ –°–Æ–î–ê –õ–ï–ì–ï–ù–î–£ -->
<div style="margin-bottom:12px;padding:12px;background:var(--bg-secondary);border-radius:6px;border:1px solid var(--border);">
    <strong style="color:var(--text-muted);font-size:13px;">–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫:</strong>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:8px;font-size:11px;">
        <div><span style="color:#48bb78;">‚úì OAS ‚â• 0.40</span> | <span style="color:#ecc94b;">‚ö† 0.30-0.39</span> | <span style="color:#f56565;">‚úó < 0.30</span></div>
        <div><span style="color:#48bb78;">‚úì FD‚Üí2Dep ‚â• 20%</span> | <span style="color:#f56565;">‚úó < 20%</span></div>
        <div><span style="color:#48bb78;">‚úì CPA < 200</span> | <span style="color:#ecc94b;">‚ö† 200-300</span> | <span style="color:#f56565;">‚úó > 300</span></div>
        <div><span style="color:#48bb78;">‚úì Avg Check > 250</span> | <span style="color:#ecc94b;">‚ö† 150-250</span> | <span style="color:#f56565;">‚úó < 150</span></div>
        <div><span style="color:#48bb78;">‚úì Crash FTD < 25%</span> | <span style="color:#ecc94b;">‚ö† 25-35%</span> | <span style="color:#f56565;">‚úó > 35%</span></div>
    </div>
</div>
<div class="table-container">
            <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</h3>
            <div style="overflow:auto;max-height:500px;">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
                            <th>–°—Ç—Ä–∞–Ω–∞</th>
                            <th>–î–∞—Ç–∞ –∫–æ–≥–æ—Ä—Ç—ã</th>
                            <th>Cost</th>
                            <th>FTD</th>
                            <th>CPA</th>
                            <th>Avg Check</th>
                            <th>Dep Count</th>
                            <th>FD‚Üí2Dep %</th>
                            <th>Dep Summ</th>
                            <th>CNGR 7D</th>
                            <th>Profit 7D</th>
                            <th>OAS 7D</th>
                            <th>Crash FTD %</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTableBody"></tbody>
                </table>
            </div>
            <!-- <div id="rowDetails" class="details-expanded" style="display:none"></div> -->
        </div>
    </div>

    <div id="noData" class="no-data">
        <p style="color:var(--text-muted);font-size:15px">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞<br>
            <span style="font-size:13px;margin-top:8px;display:block">
                –¢—Ä–µ–±—É—é—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∏: Split 1, Split 2, Cohort Date, First Deposit C, Marketing Spend,
                1D/3D/7D CNGR, 1D/3D/7D Deposit C, 1D/3D/7D Deposit S,
                24h First Deposit 2 Deposit Conversion (–∏–ª–∏ First Deposit 2 Deposit Conversion),
                Mono Instant Depositor Share (–∏–ª–∏ Crash FTD) –∏ –¥—Ä.
            </span>
        </p>
    </div>
</div>

<script>
    let rawData = [];
let charts = {};
let filters = { partner: [], country: [], dateFrom: null, dateTo: null, minFtd: 0 };

function parseNumber(v){
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') return v || 0;
    let s = String(v).replace(/\s/g, '').replace(/\$/g,'').replace(/,/g,'');
    if (s === '') return 0;
    let n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}

function parsePercent(v){
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') {
        return v <= 1 ? v * 100 : v;
    }
    let s = String(v).trim();
    if (s.endsWith('%')) s = s.slice(0,-1);
    s = s.replace(/,/g, '.').replace(/\s/g,'');
    let n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}

document.getElementById('csvFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function(results){
            rawData = results.data.map(r => normalizeRow(r)).filter(r => r['Split 1'] && r['Split 2'] && r['Cohort Date']);
            if (rawData.length === 0){
                alert('–í —Ñ–∞–π–ª–µ –Ω–µ—Ç —Å—Ç—Ä–æ–∫ —Å Split 1, Split 2 –∏ Cohort Date');
                return;
            }
            initializeFilters();
            processData();
            document.getElementById('filters').style.display = 'flex';
            document.getElementById('content').style.display = 'block';
            document.getElementById('noData').style.display = 'none';
        }
    });
});

function normalizeRow(r){
    const copy = {};
    for (let k in r){ copy[k.trim()] = r[k]; }

    copy['First Deposit C'] = parseNumber(copy['First Deposit C']);
    copy['Marketing Spend'] = parseNumber(copy['Marketing Spend']);
    copy['1D CNGR'] = parseNumber(copy['1D CNGR']);
    copy['3D CNGR'] = parseNumber(copy['3D CNGR']);
    copy['7D CNGR'] = parseNumber(copy['7D CNGR']);
    copy['1D Deposit S'] = parseNumber(copy['1D Deposit S']);
    copy['1D Deposit C'] = parseNumber(copy['1D Deposit C']);
    copy['3D Deposit S'] = parseNumber(copy['3D Deposit S']);
    copy['3D Deposit C'] = parseNumber(copy['3D Deposit C']);
    copy['7D Deposit S'] = parseNumber(copy['7D Deposit S']);
    copy['7D Deposit C'] = parseNumber(copy['7D Deposit C']);

    copy['24h First Deposit 2 Deposit Conversion'] = parsePercent(
        copy['24h First Deposit 2 Deposit Conversion'] ||
        copy['First Deposit 2 Deposit Conversion'] ||
        0
    );

    copy['Mono Instant Depositor Share'] = parsePercent(
        copy['Mono Instant Depositor Share'] ||
        copy['Crash FTD'] ||
        0
    );

    copy['Cohort Date'] = normalizeDate(copy['Cohort Date']);
    copy['Split 1'] = (copy['Split 1'] || '').toString().trim();
    copy['Split 2'] = (copy['Split 2'] || '').toString().trim();

    return copy;
}

function normalizeDate(v){
    if (!v) return null;
    if (/^\d{4}-\d{2}-\d{2}/.test(v)) return v.split('T')[0];
    const d = new Date(v);
    if (isNaN(d)) return v;
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
}

function initializeFilters(){
    const partners = [...new Set(rawData.map(r => r['Split 1']))].sort();
    const countries = [...new Set(rawData.map(r => r['Split 2']))].sort();

    const psel = document.getElementById('partnerFilter');
    psel.innerHTML = '<option value="__all__">–í—Å–µ</option>' +
        partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');

    const csel = document.getElementById('countryFilter');
    csel.innerHTML = '<option value="__all__">–í—Å–µ</option>' +
        countries.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

    document.getElementById('partnerFilter').addEventListener('change', applyFilters);
    document.getElementById('countryFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
    document.getElementById('minFtd').addEventListener('change', applyFilters);

    populateCompareSelects();
}

function getSelectedValues(selectEl){
    if (!selectEl) return [];
    const selected = Array.from(selectEl.options).filter(o => o.selected).map(o => o.value);
    if (selected.includes('__all__')) return [];
    return selected;
}

function applyFilters(){
    filters.partner = getSelectedValues(document.getElementById('partnerFilter'));
    filters.country = getSelectedValues(document.getElementById('countryFilter'));
    filters.dateFrom = document.getElementById('dateFrom').value || null;
    filters.dateTo = document.getElementById('dateTo').value || null;
    filters.minFtd = parseInt(document.getElementById('minFtd').value || 0, 10);
    processData();
}

function resetFilters(){
    filters = { partner: [], country: [], dateFrom: null, dateTo: null, minFtd: 0 };
    Array.from(document.getElementById('partnerFilter').options).forEach(o => o.selected = false);
    Array.from(document.getElementById('countryFilter').options).forEach(o => o.selected = false);
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    document.getElementById('minFtd').value = '';
    processData();
}

function getFilteredData(){
    return rawData.filter(r => {
        if (filters.partner.length && !filters.partner.includes(r['Split 1'])) return false;
        if (filters.country.length && !filters.country.includes(r['Split 2'])) return false;
        if (filters.dateFrom && r['Cohort Date'] && new Date(r['Cohort Date']) < new Date(filters.dateFrom)) return false;
        if (filters.dateTo && r['Cohort Date'] && new Date(r['Cohort Date']) > new Date(filters.dateTo)) return false;
        if (filters.minFtd && (parseNumber(r['First Deposit C']) < filters.minFtd)) return false;
        return true;
    });
}

function processData(){
    const data = getFilteredData();

    const aggregated = {};
    const partnerAgg = {};
    let overall = {
        cost:0, ftd:0,
        cngr1:0, cngr3:0, cngr7:0,
        dep1dS:0, dep1dC:0,
        dep3dS:0, dep3dC:0,
        dep7dS:0, dep7dC:0,
        fd2WeightedNum:0, fd2WeightedDen:0,
        crashWeightedNum:0, crashWeightedDen:0
    };

    data.forEach(row => {
        const key = `${row['Split 1']}|${row['Split 2']}`;
        if (!aggregated[key]) aggregated[key] = {
            partner: row['Split 1'],
            country: row['Split 2'],
            rows: [],
            ftd:0, cost:0,
            cngr1:0, cngr3:0, cngr7:0,
            dep1dS:0, dep1dC:0,
            dep3dS:0, dep3dC:0,
            dep7dS:0, dep7dC:0,
            fd2WeightedNum:0, fd2WeightedDen:0,
            crashWeightedNum:0, crashWeightedDen:0
        };
        aggregated[key].rows.push(row);

        const ftd = parseNumber(row['First Deposit C']);
        const cost = parseNumber(row['Marketing Spend']);
        const fd2 = parseNumber(row['24h First Deposit 2 Deposit Conversion']);
        const crash = parseNumber(row['Mono Instant Depositor Share']);

        aggregated[key].ftd += ftd;
        aggregated[key].cost += cost;
        aggregated[key].cngr1 += parseNumber(row['1D CNGR']);
        aggregated[key].cngr3 += parseNumber(row['3D CNGR']);
        aggregated[key].cngr7 += parseNumber(row['7D CNGR']);
        aggregated[key].dep1dS += parseNumber(row['1D Deposit S']);
        aggregated[key].dep1dC += parseNumber(row['1D Deposit C']);
        aggregated[key].dep3dS += parseNumber(row['3D Deposit S']);
        aggregated[key].dep3dC += parseNumber(row['3D Deposit C']);
        aggregated[key].dep7dS += parseNumber(row['7D Deposit S']);
        aggregated[key].dep7dC += parseNumber(row['7D Deposit C']);

        if (ftd > 0 && fd2 > 0){
            aggregated[key].fd2WeightedNum += fd2 * ftd;
            aggregated[key].fd2WeightedDen += ftd;
        }

        if (ftd > 0 && crash > 0){
            aggregated[key].crashWeightedNum += crash * ftd;
            aggregated[key].crashWeightedDen += ftd;
        }
        const p = row['Split 1'];
        if (!partnerAgg[p]) partnerAgg[p] = {
            fd2WeightedNum:0, 
            fd2WeightedDen:0,
            uniqueCohorts: new Set(),
            cohortsByCountry: {}
        };

        // –°–æ–∑–¥–∞—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á: –¥–∞—Ç–∞ + —Å—Ç—Ä–∞–Ω–∞
        const cohortKey = `${row['Cohort Date']}|${row['Split 2']}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–≥–æ—Ä—Ç—É –≤ Set (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã)
        partnerAgg[p].uniqueCohorts.add(cohortKey);
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        const country = row['Split 2'] || 'Unknown';
        if (!partnerAgg[p].cohortsByCountry[country]) {
            partnerAgg[p].cohortsByCountry[country] = {};
        }
        
        const date = row['Cohort Date'] || '‚Äî';
        if (!partnerAgg[p].cohortsByCountry[country][date]) {
            partnerAgg[p].cohortsByCountry[country][date] = {
                ftd: 0,
                fd2WeightedNum: 0,
                fd2WeightedDen: 0
            };
        }
        
        // –ê–∫–∫—É–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã (–û–î–ò–ù –†–ê–ó)
        partnerAgg[p].cohortsByCountry[country][date].ftd += ftd;
        
        if (ftd > 0 && fd2 > 0){
            partnerAgg[p].fd2WeightedNum += fd2 * ftd;
            partnerAgg[p].fd2WeightedDen += ftd;
            partnerAgg[p].cohortsByCountry[country][date].fd2WeightedNum += fd2 * ftd;
            partnerAgg[p].cohortsByCountry[country][date].fd2WeightedDen += ftd;
        }

        overall.cost += cost;
        overall.ftd += ftd;
        overall.cngr1 += parseNumber(row['1D CNGR']);
        overall.cngr3 += parseNumber(row['3D CNGR']);
        overall.cngr7 += parseNumber(row['7D CNGR']);
        overall.dep1dS += parseNumber(row['1D Deposit S']);
        overall.dep1dC += parseNumber(row['1D Deposit C']);
        overall.dep3dS += parseNumber(row['3D Deposit S']);
        overall.dep3dC += parseNumber(row['3D Deposit C']);
        overall.dep7dS += parseNumber(row['7D Deposit S']);
        overall.dep7dC += parseNumber(row['7D Deposit C']);

        if (ftd > 0 && fd2 > 0){
            overall.fd2WeightedNum += fd2 * ftd;
            overall.fd2WeightedDen += ftd;
        }

        if (ftd > 0 && crash > 0){
            overall.crashWeightedNum += crash * ftd;
            overall.crashWeightedDen += ftd;
        }
    });

    const processed = Object.values(aggregated).map(d => {
        const cpa = d.ftd > 0 ? Math.round(d.cost / d.ftd * 10) / 10 : 0;
        const avgCheck = d.ftd > 0 ? Math.round(d.dep7dS / d.ftd * 10) / 10 : 0;
        const profit7d = Math.round(d.cngr7 - d.cost);
        const oas7d = d.cost > 0 ? Math.round(d.dep7dS / d.cost * 100) / 100 : 0;
        const fd2conv = d.fd2WeightedDen > 0 ? Math.round(d.fd2WeightedNum / d.fd2WeightedDen * 10) / 10 : 0;
        const crashFtd = d.crashWeightedDen > 0 ? Math.round(d.crashWeightedNum / d.crashWeightedDen * 10) / 10 : 0;

        const isGood = (oas7d >= 0.40) && (profit7d > 0) && (fd2conv >= 20) && (cpa < 250);
        const isProblem = (oas7d < 0.30) || (fd2conv < 20) || (profit7d < -1000);

        return {
            ...d,
            cpa,
            avgCheck,
            profit7d,
            oas7d,
            fd2conv,
            crashFtd,
            isGood,
            isProblem
        };
    });

    processed.sort((a, b) => b.ftd - a.ftd);

    const totalCost = Math.round(overall.cost);
    const totalFTD = Math.round(overall.ftd);
    const overallCpa = totalFTD > 0 ? Math.round(totalCost / totalFTD * 10) / 10 : 0;
    const overallAvgCheck = totalFTD > 0 ? Math.round(overall.dep7dS / totalFTD * 10) / 10 : 0;
    const overallDepCount = Math.round(overall.dep7dC);
    const overallDepSum = Math.round(overall.dep7dS);
    const overallFd2Weighted = overall.fd2WeightedDen > 0 ? Math.round(overall.fd2WeightedNum / overall.fd2WeightedDen * 10) / 10 : 0;
    const overallCngr7 = Math.round(overall.cngr7);
    const overallProfit7 = Math.round(overall.cngr7 - overall.cost);
    const overallOas = totalCost > 0 ? Math.round(overall.dep7dS / totalCost * 100) / 100 : 0;
    const overallCrash = overall.crashWeightedDen > 0 ? Math.round(overall.crashWeightedNum / overall.crashWeightedDen * 10) / 10 : 0;

    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: —Å—á–∏—Ç–∞–µ–º FTD –∏–∑ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (–±–µ–∑ –¥—É–±–ª–µ–π)
    const fd2Partners = Object.keys(partnerAgg).map(p => {
        const pa = partnerAgg[p];
        const weighted = pa.fd2WeightedDen > 0 ? Math.round(pa.fd2WeightedNum / pa.fd2WeightedDen * 10) / 10 : 0;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä Set –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–≥–æ—Ä—Ç
        const uniqueCohortsCount = pa.uniqueCohorts.size;
        
        // –°—á–∏—Ç–∞–µ–º –†–ï–ê–õ–¨–ù–´–ô FTD –∏–∑ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
        let totalFtd = 0;
        Object.values(pa.cohortsByCountry).forEach(countryData => {
            Object.values(countryData).forEach(dateData => {
                totalFtd += dateData.ftd;
            });
        });
        
        return {
            partner: p,
            weighted: weighted,
            ftdSum: totalFtd,  // ‚Üê –ö–û–†–†–ï–ö–¢–ù–û–ï –ó–ù–ê–ß–ï–ù–ò–ï –ë–ï–ó –î–£–ë–õ–ï–ô
            cohortsCount: uniqueCohortsCount,
            cohortsByCountry: pa.cohortsByCountry
        };
    }).filter(x => x.cohortsCount > 0).sort((a,b)=>b.ftdSum - a.ftdSum);

    displayMetrics({
        totalCost,
        totalFTD,
        overallCpa,
        overallAvgCheck,
        overallDepCount,
        overallDepSum,
        overallFd2Weighted,
        overallCngr7,
        overallProfit7,
        overallOas,
        overallCrash,
        fd2Partners
    });
    displayCharts(data, processed);
    displayTable(processed);
    displayProblemLists(processed);
    populateCompareSelects();
}

function displayMetrics(vals){
    const metrics = [
        { label: 'Cost', value: `${vals.totalCost.toLocaleString('en-US')}`, change:null },
        { label: 'FTD', value: `${vals.totalFTD.toLocaleString('en-US')}`, change:null },
        { label: 'CPA', value: `${vals.overallCpa.toFixed(1)}`, change: vals.overallCpa < 200 ? 'positive' : vals.overallCpa < 300 ? null : 'negative' },
        { label: 'Avg Check', value: `${vals.overallAvgCheck.toFixed(1)}`, change: vals.overallAvgCheck > 250 ? 'positive' : vals.overallAvgCheck > 150 ? null : 'negative' },
        { label: 'Dep Count', value: `${vals.overallDepCount}`, change:null },
        { label: 'FD‚Üí2Dep %', value: `${vals.overallFd2Weighted.toFixed(1)}%`, change: vals.overallFd2Weighted >= 20 ? 'positive' : 'negative' },
        { label: 'Dep Summ', value: `${vals.overallDepSum.toLocaleString('en-US')}`, change:null },
        { label: 'CNGR 7D', value: `${vals.overallCngr7.toLocaleString('en-US')}`, change: vals.overallCngr7 > 0 ? 'positive' : 'negative' },
        { label: 'Profit 7D', value: `${vals.overallProfit7.toLocaleString('en-US')}`, change: vals.overallProfit7 > 0 ? 'positive' : 'negative'},
        { label: 'OAS 7D', value: vals.overallOas.toFixed(2), change: vals.overallOas >= 0.40 ? 'positive' : vals.overallOas >= 0.30 ? 'warning' : 'negative' },
        { label: 'Crash FTD %', value: `${vals.overallCrash.toFixed(1)}%`, change: vals.overallCrash < 25 ? 'positive' : vals.overallCrash < 35 ? 'warning' : 'negative' }
    ];
    const html = metrics.map(m => `
        <div class="metric-card">
            <div class="metric-label">${m.label}</div>
            <div class="metric-value ${m.change||''}">${m.value}</div>
        </div>
    `).join('');
    document.getElementById('metricsGrid').innerHTML = html;

    const weighted = vals.overallFd2Weighted.toFixed(1);
    const partners = vals.fd2Partners || [];
    const breakdown = `FD‚Üí2Dep (–≤–∑–≤–µ—à–µ–Ω–Ω–æ–µ –ø–æ FTD): ${weighted}% ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ ${partners.length} –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º (—É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä—ã —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ FTD –∏ FD‚Üí2Dep –≤ –¥–∞–Ω–Ω—ã—Ö).`;
    document.getElementById('fd2Breakdown').textContent = breakdown;

    if (!partners.length){
        document.getElementById('fd2Contributors').innerHTML = '<div style="color:var(--text-muted)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ FD‚Üí2Dep –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö</div>';
        return;
    }

    const rows = partners.map(p => {
        const id = makeId(p.partner);
        const weightedStr = p.weighted.toFixed(1) + '%';
        const ftdSum = Math.round(p.ftdSum);
        const cohortsCount = p.cohortsCount;

        const impactClass = p.weighted < weighted - 2 ? 'negative' : p.weighted > weighted + 2 ? 'positive' : '';
        const impactText = p.weighted < weighted - 2 ? '‚ö†Ô∏è –¢—è–Ω–µ—Ç –≤–Ω–∏–∑' : p.weighted > weighted + 2 ? '‚úì –í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ' : '~ –°—Ä–µ–¥–Ω–∏–π';

        // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const countryDetails = Object.keys(p.cohortsByCountry).map(country => {
            const dates = p.cohortsByCountry[country];
            const dateKeys = Object.keys(dates).sort();
            
            // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ —Å—Ç—Ä–∞–Ω–µ
            let totalFtd = 0;
            let totalFd2WeightedNum = 0;
            let totalFd2WeightedDen = 0;
            
            dateKeys.forEach(date => {
                totalFtd += dates[date].ftd;
                totalFd2WeightedNum += dates[date].fd2WeightedNum;
                totalFd2WeightedDen += dates[date].fd2WeightedDen;
            });
            
            const avgFd2 = totalFd2WeightedDen > 0 ? totalFd2WeightedNum / totalFd2WeightedDen : 0;
            const totalSecondDeposits = Math.round(totalFd2WeightedNum / 100);
            const isSmallSample = totalFtd < 10;
            const sampleWarning = isSmallSample ? ' ‚ö†Ô∏è –ú–∞–ª–∞—è –≤—ã–±–æ—Ä–∫–∞!' : '';
            const cohortsInCountry = dateKeys.length;

            let fd2Class = '';
            if (isSmallSample) {
                fd2Class = 'warning';
            } else {
                fd2Class = avgFd2 >= 20 ? 'positive' : avgFd2 >= 15 ? 'warning' : 'negative';
            }

            return `
        <div style="margin:6px 0;padding:8px;background:rgba(0,0,0,0.2);border-radius:4px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>${escapeHtml(country)}</strong>:
                    <span class="${fd2Class}">${avgFd2.toFixed(1)}%</span>${sampleWarning}
                </div>
                <div style="font-size:11px;color:var(--text-muted);">
                    ${totalSecondDeposits} –∏–∑ ${Math.round(totalFtd)} —Å–¥–µ–ª–∞–ª–∏ 2-–π –¥–µ–ø–æ–∑–∏—Ç
                </div>
            </div>
            <div style="margin-top:6px;font-size:11px;color:var(--text-muted);">
                –í—Å–µ–≥–æ FTD: ${Math.round(totalFtd)} | –ö–æ–≥–æ—Ä—Ç (—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç): ${cohortsInCountry} | 2-–µ –¥–µ–ø–æ–∑–∏—Ç—ã: ${totalSecondDeposits}
            </div>
            <div style="margin-top:6px;font-size:11px;opacity:0.7;border-top:1px solid var(--border);padding-top:6px;">
                <strong>–ü–æ –¥–∞—Ç–∞–º –∫–æ–≥–æ—Ä—Ç:</strong><br>
                ${dateKeys.map(date => {
                    const dateData = dates[date];
                    const dateFd2 = dateData.fd2WeightedDen > 0 ? dateData.fd2WeightedNum / dateData.fd2WeightedDen : 0;
                    const secondDeps = Math.round(dateData.fd2WeightedNum / 100);
                    return `${date}: ${dateFd2.toFixed(1)}% (${secondDeps} –∏–∑ ${Math.round(dateData.ftd)} FTD)`;
                }).join('<br>')}
            </div>
        </div>
    `;
        }).join('');

        return `<tr>
            <td><strong>${escapeHtml(p.partner)}</strong></td>
            <td class="${impactClass}">${weightedStr}</td>
            <td>${ftdSum.toLocaleString('en-US')}</td>
            <td>${cohortsCount}</td>
            <td class="${impactClass}">${impactText}</td>
            <td><button class="toggle-btn" onclick="togglePartnerDetails('${id}')">–î–µ—Ç–∞–ª–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º</button></td>
        </tr>
        <tr id="details-${id}" style="display:none;">
            <td colspan="6" class="small-cohort-list">
                <strong>–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–≥–æ—Ä—Ç—ã = –¥–∞—Ç–∞ + —Å—Ç—Ä–∞–Ω–∞):</strong>
                ${countryDetails}
            </td>
        </tr>`;
    }).join('');

    const tableHtml = `<table class="fd-contrib-table">
        <thead><tr>
            <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
            <th>FD‚Üí2Dep (–≤–∑–≤.)</th>
            <th>–°—É–º–º–∞—Ä–Ω—ã–π FTD</th>
            <th>–ö–æ–≥–æ—Ä—Ç (—É–Ω–∏–∫. –¥–∞—Ç–∞+—Å—Ç—Ä–∞–Ω–∞)</th>
            <th>–û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è</th>
            <th></th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
    document.getElementById('fd2Contributors').innerHTML = `
        <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border);">
            <h3 style="color:var(--text-muted);font-size:14px;margin-bottom:8px;">
                –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è FD‚Üí2Dep –ø–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º
            </h3>
           
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">
                –í–∫–ª–∞–¥ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ –æ–±—â—É—é –∫–æ–Ω–≤–µ—Ä—Å–∏—é. –ü–∞—Ä—Ç–Ω—ë—Ä—ã —Å FD‚Üí2Dep –Ω–∏–∂–µ ${weighted}% —Ç—è–Ω—É—Ç –º–µ—Ç—Ä–∏–∫—É –≤–Ω–∏–∑.
            </div>
            ${tableHtml}
        </div>
    `;
}

function togglePartnerDetails(id){
    const el = document.getElementById('details-'+id);
    if (!el) return;
    el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'table-row' : 'none';
}

function makeId(s){
    return String(s || '').replace(/[^a-z0-9]/gi, '_').toLowerCase();
}

function displayCharts(rawData, aggregated){
    const cngrCtx = document.getElementById('cngrChart').getContext('2d');
    if (charts.cngr) charts.cngr.destroy();
    const top10 = aggregated.slice().sort((a,b)=>b.cngr7 - a.cngr7).slice(0,10);
    charts.cngr = new Chart(cngrCtx, {
        type:'bar',
        data:{
            labels: top10.map(d=>truncate(d.partner,18)),
            datasets:[{
                label: 'CNGR 7D',
                data: top10.map(d=>d.cngr7),
                backgroundColor: top10.map(d => d.cngr7 < 0 ? 'rgba(245,101,101,0.9)' : 'rgba(72,187,120,0.9)')
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{display:false}},
            scales:{x:{ticks:{color:'#a0aec0'}},y:{ticks:{color:'#a0aec0'}}}
        }
    });

    const oasCtx = document.getElementById('oasChart').getContext('2d');
    if (charts.oas) charts.oas.destroy();
    const byDate = {};
    rawData.forEach(r => {
        const d = r['Cohort Date'] || 'unknown';
        if (!byDate[d]) byDate[d] = { cost:0, dep1dS:0, dep3dS:0, dep7dS:0 };
        byDate[d].cost += parseNumber(r['Marketing Spend']);
        byDate[d].dep1dS += parseNumber(r['1D Deposit S']);
        byDate[d].dep3dS += parseNumber(r['3D Deposit S']);
        byDate[d].dep7dS += parseNumber(r['7D Deposit S']);
    });
    const dates = Object.keys(byDate).sort().slice(-14);
    charts.oas = new Chart(oasCtx, {
        type:'line',
        data:{
            labels: dates,
            datasets:[
                {
                    label:'OAS 1D',
                    data: dates.map(d=>byDate[d].cost>0 ? byDate[d].dep1dS/byDate[d].cost : 0),
                    borderColor:'rgba(245,101,101,1)',
                    backgroundColor:'rgba(245,101,101,0.08)',
                    tension:0.3
                },
                {
                    label:'OAS 3D',
                    data: dates.map(d=>byDate[d].cost>0 ? byDate[d].dep3dS/byDate[d].cost : 0),
                    borderColor:'rgba(236,201,75,1)',
                    backgroundColor:'rgba(236,201,75,0.06)',
                    tension:0.3
                },
                {
                    label:'OAS 7D',
                    data: dates.map(d=>byDate[d].cost>0 ? byDate[d].dep7dS/byDate[d].cost : 0),
                    borderColor:'rgba(72,187,120,1)',
                    backgroundColor:'rgba(72,187,120,0.06)',
                    tension:0.3
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#e6eef6'}}},
            scales:{x:{ticks:{color:'#a0aec0'}},y:{ticks:{color:'#a0aec0'}}}
        }
    });

    const profitCtx = document.getElementById('profitChart').getContext('2d');
    if (charts.profit) charts.profit.destroy();
    const topProfit = aggregated.slice().sort((a,b)=> b.profit7d - a.profit7d).slice(0,10);
    charts.profit = new Chart(profitCtx, {
        type:'bar',
        data:{
            labels: topProfit.map(d=>truncate(d.partner,18)),
            datasets:[
                {label:'Cost (neg)', data: topProfit.map(d=>-d.cost), backgroundColor:'rgba(245,101,101,0.85)'},
                {label:'CNGR 7D', data: topProfit.map(d=>d.cngr7), backgroundColor:'rgba(72,187,120,0.85)'}
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#e6eef6'}}},
            scales:{x:{ticks:{color:'#a0aec0'}},y:{ticks:{color:'#a0aec0'}}}
        }
    });
}

function displayTable(data){
    const tbody = document.getElementById('detailsTableBody');
    tbody.innerHTML = data.map(d => {
        const oasClass = d.oas7d >= 0.40 ? 'positive' : d.oas7d >= 0.30 ? 'warning' : 'negative';
        const fdClass = d.fd2conv >= 20 ? 'positive' : 'negative';
        const profitClass = d.profit7d > 0 ? 'positive' : 'negative';
        const cpaClass = d.cpa < 200 ? 'positive' : d.cpa < 300 ? '' : 'negative';
        const avgCheckClass = d.avgCheck > 250 ? 'positive' : d.avgCheck > 150 ? '' : 'negative';
        const crashClass = d.crashFtd < 25 ? 'positive' : d.crashFtd < 35 ? 'warning' : 'negative';
        const statusClass = d.isGood ? 'status-good' : 'status-bad';

        return `<tr data-key="${escapeHtml(d.partner)}|${escapeHtml(d.country)}">
            <td><strong>${escapeHtml(d.partner)}</strong></td>
            <td>${escapeHtml(d.country)}</td>
            <td>${escapeHtml(d.rows.map(r=>r['Cohort Date']).filter(Boolean).slice(0,1)[0] || '')}</td>
            <td>${Math.round(d.cost).toLocaleString('en-US')}</td>
            <td>${Math.round(d.ftd)}</td>
            <td class="${cpaClass}">${d.cpa.toFixed(1)}</td>
            <td class="${avgCheckClass}">${d.avgCheck.toFixed(1)}</td>
            <td>${Math.round(d.dep7dC)}</td>
            <td class="${fdClass}">${d.fd2conv.toFixed(1)}%</td>
            <td>${Math.round(d.dep7dS).toLocaleString('en-US')}</td>
            <td>${Math.round(d.cngr7).toLocaleString('en-US')}</td>
            <td class="${profitClass}">${Math.round(d.profit7d).toLocaleString('en-US')}</td>
            <td class="${oasClass}">${d.oas7d.toFixed(2)}</td>
            <td class="${crashClass}">${d.crashFtd.toFixed(1)}%</td>
            <td><span class="status-badge ${statusClass}">${d.isGood ? '–•–û–†–û–®–û' : '–ü–õ–û–•–û'}</span></td>
        </tr>`;
    }).join('');
}




function displayProblemLists(processed){
    const problems = processed.filter(p => p.isProblem).sort((a,b)=>a.oas7d - b.oas7d).slice(0,10);
    const problemHtml = problems.length ? problems.map(p => {
        const reasons = [];
        if (p.oas7d < 0.30) reasons.push(`–Ω–∏–∑–∫–∏–π OAS ${p.oas7d.toFixed(2)}`);
        if (p.fd2conv < 20) reasons.push(`–Ω–∏–∑–∫–∞—è FD‚Üí2Dep ${p.fd2conv.toFixed(1)}%`);
        if (p.profit7d < -1000) reasons.push(`—É–±—ã—Ç–æ–∫ ${Math.round(p.profit7d)}`);
        if (p.cpa > 300) reasons.push(`–≤—ã—Å–æ–∫–∏–π CPA ${p.cpa.toFixed(1)}`);

        return `<div class="problem-item">
            <strong>${escapeHtml(p.partner)}</strong> / ${escapeHtml(p.country)}<br>
            <span style="color:var(--text-muted);font-size:12px">
                –ü—Ä–æ–±–ª–µ–º—ã: ${reasons.join(', ')}<br>
                FTD: ${Math.round(p.ftd)} | Cost: ${Math.round(p.cost)} | Profit: ${Math.round(p.profit7d)}
            </span>
        </div>`;
    }).join('') : '<div style="color:var(--text-muted)">–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–æ–≥–æ—Ä—Ç</div>';
    document.getElementById('problemList').innerHTML = problemHtml;

    const good = processed.filter(p => p.isGood).sort((a,b)=>b.profit7d - a.profit7d).slice(0,10);
    const goodHtml = good.length ? good.map(p => `<div class="problem-item good">
            <strong>${escapeHtml(p.partner)}</strong> / ${escapeHtml(p.country)}<br>
            <span style="color:var(--text-muted);font-size:12px">
                OAS: ${p.oas7d.toFixed(2)} | FD‚Üí2Dep: ${p.fd2conv.toFixed(1)}% | CPA: ${p.cpa.toFixed(1)}<br>
                Profit: ${Math.round(p.profit7d)} | Avg Check: ${p.avgCheck.toFixed(1)}
            </span>
        </div>`).join('') : '<div style="color:var(--text-muted)">–ü–æ–∫–∞ –Ω–µ—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–≥–æ—Ä—Ç</div>';
    document.getElementById('goodList').innerHTML = goodHtml;
}

function populateCompareSelects(){
    const partners = [...new Set(rawData.map(r=>r['Split 1']))].sort();
    const compareA = document.getElementById('compareA');
    const compareB = document.getElementById('compareB');
    if (!compareA || !compareB) return;

    const selA = compareA.value;
    const selB = compareB.value;

    compareA.innerHTML = '<option value="">‚Äî</option>' + partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    compareB.innerHTML = '<option value="">‚Äî</option>' + partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');

    if (partners.includes(selA)) compareA.value = selA;
    if (partners.includes(selB)) compareB.value = selB;
}

function compareSelected(){
    const a = document.getElementById('compareA').value;
    const b = document.getElementById('compareB').value;

    if (!a || !b || a===b) {
        document.getElementById('compareResult').innerHTML = '<span style="color:var(--text-muted)">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–∞</span>';
        return;
    }

    const filtered = getFilteredData();
    const aggr = {};

    filtered.forEach(r => {
        const key = r['Split 1'];
        if (!aggr[key]) aggr[key] = {
            ftd:0, cost:0, cngr7:0,
            dep7dS:0, dep7dC:0,
            fd2WeightedNum:0, fd2WeightedDen:0,
            crashWeightedNum:0, crashWeightedDen:0
        };

        const ftd = parseNumber(r['First Deposit C']);
        const fd2 = parseNumber(r['24h First Deposit 2 Deposit Conversion']);
        const crash = parseNumber(r['Mono Instant Depositor Share']);

        aggr[key].ftd += ftd;
        aggr[key].cost += parseNumber(r['Marketing Spend']);
        aggr[key].cngr7 += parseNumber(r['7D CNGR']);
        aggr[key].dep7dS += parseNumber(r['7D Deposit S']);
        aggr[key].dep7dC += parseNumber(r['7D Deposit C']);

        if (ftd > 0 && fd2 > 0){
            aggr[key].fd2WeightedNum += fd2 * ftd;
            aggr[key].fd2WeightedDen += ftd;
        }

        if (ftd > 0 && crash > 0){
            aggr[key].crashWeightedNum += crash * ftd;
            aggr[key].crashWeightedDen += ftd;
        }
    });

    const A = aggr[a] || {ftd:0,cost:0,cngr7:0,dep7dS:0,dep7dC:0,fd2WeightedNum:0,fd2WeightedDen:0,crashWeightedNum:0,crashWeightedDen:0};
    const B = aggr[b] || {ftd:0,cost:0,cngr7:0,dep7dS:0,dep7dC:0,fd2WeightedNum:0,fd2WeightedDen:0,crashWeightedNum:0,crashWeightedDen:0};

    const cpaA = A.ftd ? (A.cost/A.ftd) : 0;
    const cpaB = B.ftd ? (B.cost/B.ftd) : 0;
    const oasA = A.cost ? (A.dep7dS/A.cost) : 0;
    const oasB = B.cost ? (B.dep7dS/B.cost) : 0;
    const profitA = A.cngr7 - A.cost;
    const profitB = B.cngr7 - B.cost;
    const fd2A = A.fd2WeightedDen ? (A.fd2WeightedNum/A.fd2WeightedDen) : 0;
    const fd2B = B.fd2WeightedDen ? (B.fd2WeightedNum/B.fd2WeightedDen) : 0;
    const avgCheckA = A.ftd ? (A.dep7dS/A.ftd) : 0;
    const avgCheckB = B.ftd ? (B.dep7dS/B.ftd) : 0;
    const crashA = A.crashWeightedDen ? (A.crashWeightedNum/A.crashWeightedDen) : 0;
    const crashB = B.crashWeightedDen ? (B.crashWeightedNum/B.crashWeightedDen) : 0;

    const summary = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px;">
            <div style="background:var(--bg-tertiary);padding:12px;border-radius:6px;">
                <strong style="color:var(--accent);">${escapeHtml(a)}</strong>
                <div style="margin-top:8px;font-size:12px;color:var(--text-muted);line-height:1.6">
                    Cost: <span class="metric-value">${Math.round(A.cost)}</span><br>
                    FTD: <span class="metric-value">${Math.round(A.ftd)}</span><br>
                    CPA: <span class="metric-value ${cpaA<200?'positive':cpaA<300?'':'negative'}">${cpaA.toFixed(1)}</span><br>
                    Avg Check: <span class="metric-value ${avgCheckA>250?'positive':avgCheckA>150?'':'negative'}">${avgCheckA.toFixed(1)}</span><br>
                    Dep Count: <span class="metric-value">${Math.round(A.dep7dC)}</span><br>
                    FD‚Üí2Dep: <span class="metric-value ${fd2A>=20?'positive':'negative'}">${fd2A.toFixed(1)}%</span><br>
                    Dep Summ: <span class="metric-value">${Math.round(A.dep7dS)}</span><br>
                    CNGR: <span class="metric-value ${A.cngr7>0?'positive':'negative'}">${Math.round(A.cngr7)}</span><br>
                    Profit: <span class="metric-value ${profitA>0?'positive':'negative'}">${Math.round(profitA)}</span><br>
                    OAS: <span class="metric-value ${oasA>=0.40?'positive':oasA>=0.30?'warning':'negative'}">${oasA.toFixed(2)}</span><br>
                    Crash FTD: <span class="metric-value ${crashA<25?'positive':crashA<35?'warning':'negative'}">${crashA.toFixed(1)}%</span>
                </div>
            </div>
            <div style="background:var(--bg-tertiary);padding:12px;border-radius:6px;">
                <strong style="color:var(--accent);">${escapeHtml(b)}</strong>
                <div style="margin-top:8px;font-size:12px;color:var(--text-muted);line-height:1.6">
                    Cost: <span class="metric-value">${Math.round(B.cost)}</span><br>
                    FTD: <span class="metric-value">${Math.round(B.ftd)}</span><br>
                    CPA: <span class="metric-value ${cpaB<200?'positive':cpaB<300?'':'negative'}">${cpaB.toFixed(1)}</span><br>
                    Avg Check: <span class="metric-value ${avgCheckB>250?'positive':avgCheckB>150?'':'negative'}">${avgCheckB.toFixed(1)}</span><br>
                    Dep Count: <span class="metric-value">${Math.round(B.dep7dC)}</span><br>
                    FD‚Üí2Dep: <span class="metric-value ${fd2B>=20?'positive':'negative'}">${fd2B.toFixed(1)}%</span><br>
                    Dep Summ: <span class="metric-value">${Math.round(B.dep7dS)}</span><br>
                    CNGR: <span class="metric-value ${B.cngr7>0?'positive':'negative'}">${Math.round(B.cngr7)}</span><br>
                    Profit: <span class="metric-value ${profitB>0?'positive':'negative'}">${Math.round(profitB)}</span><br>
                    OAS: <span class="metric-value ${oasB>=0.40?'positive':oasB>=0.30?'warning':'negative'}">${oasB.toFixed(2)}</span><br>
                    Crash FTD: <span class="metric-value ${crashB<25?'positive':crashB<35?'warning':'negative'}">${crashB.toFixed(1)}%</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('compareResult').innerHTML = summary;
}

function escapeHtml(s){
    if (s===null||s===undefined) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function truncate(s,n){
    return s.length>n ? s.slice(0,n-1)+'...' : s;
}

window.addEventListener('DOMContentLoaded', () => {
    fetch('dash.csv').then(response => {
        if (!response.ok) throw new Error('No file');
        return response.text();
    }).then(csvText => {
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data.map(r => normalizeRow(r)).filter(r => r['Split 1'] && r['Split 2'] && r['Cohort Date']);
                if (rawData.length === 0) {
                    alert('–í —Ñ–∞–π–ª–µ data.csv –Ω–µ—Ç —Å—Ç—Ä–æ–∫ —Å Split 1, Split 2 –∏ Cohort Date');
                    document.getElementById('csvFile').style.display = 'block';
                    return;
                }
                initializeFilters();
                processData();
                document.getElementById('filters').style.display = 'flex';
                document.getElementById('content').style.display = 'block';
                document.getElementById('noData').style.display = 'none';
            }
        });
    }).catch(err => {
        document.getElementById('csvFile').style.display = 'block';
    });
});
</script>
</body>
</html>
